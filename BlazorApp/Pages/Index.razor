@page "/"
@page "/search/{id}"
@using BlazorApp.Data
@inject EmployeeService EmployeeService
@using Humanizer

<PageTitle>Home</PageTitle>

<div class="topFade"></div>

<!-- Search forms and employee list can remain as before -->
<form>
	<input type="text" placeholder="Enter search term"
		   @bind="searchTerm"
		   @bind:event="oninput"
		   @bind:after="Search" />
	<label for="searchType"> Search by:</label>
	<select id="searchType" @bind="selectedSearchType">
		<option value="Message Control ID">Message Control ID</option>
		<option value="MRN">MRN</option>
		<option value="Last Name">Last Name</option>
	</select>
</form>

<body>
	<div class="container">
		@if (EmployeeService.recordsLoading)
		{
			<p>Loading records, please wait...</p>
		}
		else if (visibleCount != 0)
		{
			@foreach (Tools.Message msg in EmployeeService.hl7Messages
					.OrderBy(record => record.MessageHeader.DateTimeOfMessage)
					.Where(x => x.MessageHeader.MessageControlId == searchTerm || selectedSearchType != "Message Control ID")
					.Where(y =>
					(y.PatientIdentification.PatientAccountNumber != null &&
					y.PatientIdentification.PatientAccountNumber == searchTerm) ||
					(y.PatientIdentification.PatientIdentifierList != null &&
					y.PatientIdentification.PatientIdentifierList.IdNumber == searchTerm) ||
					selectedSearchType != "MRN")
					.Where(z => z.PatientIdentification.PatientName.FamilyName.ToLower().Contains(searchTerm.ToLower()) || selectedSearchType != "Last Name")
					.Take(visibleCount))
			{
				<RecordCard msg="@msg" />
			}
			if (EmployeeService.hl7Messages.Count == 0)
			{
				<p>No results</p>
			}
			if (EmployeeService.hl7Messages.Count > 10 && EmployeeService.hl7Messages.Count > visibleCount)
			{
				<div class="box" style="width:calc(90% + 30px); height:10%;">
					<center>
						Showing @Math.Min(999999, visibleCount) of matching employees.<br />
						<a class="underline" @onclick="() => visibleCount += 10">Click here to see more</a>
					</center>
				</div>
			}
		}
		else if (EmployeeService.isLoading)
		{
			<p>Loading employees, please wait...</p>
		}
	</div>
</body>

<div class="bottomFade"></div>

@code {
	[Parameter] public string id { get; set; }
	private int visibleCount = 2000;

	private string selectedSearchType;
	private string searchTerm = "";

	protected override async Task OnAfterRenderAsync(bool first)
	{
		if (first)
		{
			_ = EmployeeService.LoadHL7RecordsAsync();
			EmployeeService.OnHL7MessagesLoaded += StateHasChanged; // Update UI when messages load
		}
	}

	// Call SearchMRN when the 'id' parameter changes
	protected override async Task OnParametersSetAsync()
	{
		if (!string.IsNullOrEmpty(id))
		{
			SearchMRN(id);
		}
	}

	private void Search()
	{
		visibleCount = 10; // Reset visibleCount on new search
		if (string.IsNullOrEmpty(searchTerm)) visibleCount = 0;
		StateHasChanged();
	}

	private void SearchMRN(string id)
	{
		searchTerm = id;
		selectedSearchType = "MRN";
		visibleCount = 10; // Reset the visible count for a fresh search
		StateHasChanged();
	}
}
